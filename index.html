<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maheshwari Computers - Task Flow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --dark-bg: #212529;
            --light-bg: #f8f9fa;
            --secondary-bg: #e9ecef;
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --text-color: #ffffff;
            --header-color: #343a40;
            --high-priority: #dc3545;
            --medium-priority: #ffc107;
            --low-priority: #198754;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: #343a40;
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--light-bg);
        }

        .login-form, .register-form, .forgot-password-form {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }

        .main-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background-color: var(--dark-bg);
            color: var(--text-color);
            padding: 1.5rem 1rem;
            transition: transform 0.3s ease-in-out;
            transform: translateX(0);
            z-index: 1030;
            flex-shrink: 0;
            position: fixed;
            height: 100%;
        }

        /* Desktop view */
        @media (min-width: 769px) {
            .sidebar {
                transform: translateX(0);
                position: sticky;
                top: 0;
                height: 100vh;
            }
            .main-content {
                margin-left: 280px;
                transition: margin-left 0.3s ease-in-out;
            }
            .navbar-top {
                margin-left: 280px;
                width: calc(100% - 280px);
            }
            .sidebar-close-btn {
                display: none;
            }
            .sidebar-toggle {
                display: none;
            }
        }
        
        .sidebar-header {
            text-align: center;
            padding-bottom: 1rem;
            border-bottom: 1px solid #495057;
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        .sidebar-header h4 {
            color: #fff;
            font-weight: 600;
        }
        
        .sidebar-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            position: absolute;
            right: 0;
            top: 0;
            display: none;
        }

        .sidebar a {
            color: var(--text-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1.25rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s, transform 0.2s;
        }

        .sidebar a.active, .sidebar a:hover {
            background-color: #495057;
            transform: translateX(5px);
        }

        .main-content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .navbar-top {
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            padding: 1rem 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .navbar-top .navbar-brand, .navbar-top .d-flex {
            margin: 0;
        }

        .navbar-top h4 {
            flex-grow: 1;
            text-align: center;
            margin: 0;
        }

        .card {
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border: none;
        }
        
        .card-header {
            background-color: var(--secondary-bg);
            border-bottom: none;
            font-weight: bold;
            border-radius: 10px 10px 0 0;
        }
        
        .card-title {
            color: var(--header-color);
            font-weight: 600;
        }
        
        .form-control, .btn {
            border-radius: 8px;
        }

        .alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }

        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .certificate-container {
            background-color: #fff;
            border: 5px solid #0d6efd;
            padding: 3rem;
            text-align: center;
            font-family: 'Times New Roman', serif;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .certificate-header {
            font-family: 'Georgia', serif;
            color: #c4403d;
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .certificate-text {
            font-size: 1.2rem;
            line-height: 1.8;
        }
        
        .certificate-signature {
            margin-top: 3rem;
            text-align: left;
        }
        
        .certificate-signature p {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .certificate-logo {
            max-width: 150px;
            height: auto;
        }
        
        .priority-high { background-color: var(--high-priority); color: white; }
        .priority-medium { background-color: var(--medium-priority); color: black; }
        .priority-low { background-color: var(--low-priority); color: white; }
        
        .task-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .task-list-item:last-child {
            border-bottom: none;
        }
        
        .task-list-item .badge {
            min-width: 70px;
        }
        
        .notification-badge {
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            position: absolute;
            right: 15px;
            top: 15px;
            animation: blinker 1s linear infinite;
        }

        @keyframes blinker {
            50% { opacity: 0; }
        }

        /* Mobile view */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-280px);
            }
            .sidebar.show {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
            .sidebar-close-btn {
                display: block;
            }
            .sidebar-toggle {
                display: block;
            }
            .navbar-top {
                margin-left: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <div id="auth-pages" class="login-container">
            <div id="login-page">
                <div class="login-form text-center">
                    <h2 class="mb-4">Login</h2>
                    <div id="login-alert-container"></div>
                    <form id="login-form">
                        <div class="mb-3">
                            <input type="email" class="form-control" id="login-email" placeholder="Email" required>
                        </div>
                        <div class="mb-3">
                            <input type="password" class="form-control" id="login-password" placeholder="Password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mb-3">Login</button>
                    </form>
                    <a href="#" id="forgot-password-link" class="d-block mb-2">Forgot Password?</a>
                    <a href="#" id="create-account-link" class="d-block">Create New Account</a>
                </div>
            </div>

            <div id="register-page" class="d-none">
                <div class="register-form text-center">
                    <h2 class="mb-4">Create Account</h2>
                    <div id="register-alert-container"></div>
                    <form id="register-form">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="register-name" placeholder="Full Name" required>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control" id="register-employee-id" placeholder="Employee ID (pocketHR)" required>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control" id="register-location" placeholder="Location" required>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control" id="register-project" placeholder="Project Name" required>
                        </div>
                        <div class="mb-3">
                            <input type="tel" class="form-control" id="register-mobile" placeholder="Mobile Number" required>
                        </div>
                        <div class="mb-3">
                            <input type="email" class="form-control" id="register-email" placeholder="Email" required>
                        </div>
                        <div class="mb-3">
                            <input type="password" class="form-control" id="register-password" placeholder="Password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mb-3">Register</button>
                    </form>
                    <a href="#" id="back-to-login-link" class="d-block">Back to Login</a>
                </div>
            </div>

            <div id="forgot-password-page" class="d-none">
                <div class="forgot-password-form text-center">
                    <h2 class="mb-4">Forgot Password</h2>
                    <div id="forgot-password-alert-container"></div>
                    <form id="forgot-password-form">
                        <div class="mb-3">
                            <input type="email" class="form-control" id="forgot-password-email" placeholder="Email" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mb-3">Send Reset Link</button>
                    </form>
                    <a href="#" id="back-to-login-link2" class="d-block">Back to Login</a>
                </div>
            </div>
        </div>

        <div id="main-app" class="main-wrapper d-none">
            <div id="sidebar" class="sidebar">
                <div class="sidebar-header">
                    <h4>Task Flow</h4>
                    <button class="sidebar-close-btn" id="sidebar-close-btn"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <ul class="nav flex-column" id="sidebar-menu">
                    <li class="nav-item mb-2">
                        <a href="#" class="nav-link active" data-page="dashboard-page">
                            <i class="fa-solid fa-house me-2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item mb-2 employee-only">
                        <a href="#" class="nav-link" data-page="tasks-page">
                            <i class="fa-solid fa-list-check me-2"></i> My Tasks
                        </a>
                    </li>
                    <li class="nav-item mb-2 employee-only">
                        <a href="#" class="nav-link" data-page="add-task-page">
                            <i class="fa-solid fa-plus-circle me-2"></i> Add My Task
                        </a>
                    </li>
                    <li class="nav-item mb-2 employee-only">
                        <a href="#" class="nav-link" data-page="certificates-page">
                            <i class="fa-solid fa-certificate me-2"></i> My Certificates
                        </a>
                    </li>
                    <li class="nav-item mb-2 manager-only">
                        <a href="#" class="nav-link" data-page="create-team-page">
                            <i class="fa-solid fa-users me-2"></i> My Team
                        </a>
                    </li>
                    <li class="nav-item mb-2 manager-only">
                        <a href="#" class="nav-link" data-page="assign-tasks-page">
                            <i class="fa-solid fa-calendar-plus me-2"></i> Assign Tasks
                        </a>
                    </li>
                    <li class="nav-item mb-2 manager-only position-relative">
                        <a href="#" class="nav-link" data-page="review-tasks-page">
                            <i class="fa-solid fa-user-check me-2"></i> Review Tasks
                            <span id="review-tasks-notification" class="notification-badge d-none"></span>
                        </a>
                    </li>
                    <li class="nav-item mb-2 manager-only">
                        <a href="#" class="nav-link" data-page="manager-task-history-page">
                            <i class="fa-solid fa-list-ul me-2"></i> Team Task History
                        </a>
                    </li>
                    <li class="nav-item mb-2 admin-only">
                                <a href="#" class="nav-link" data-page="assign-tasks-admin-page">
                                    <i class="fa-solid fa-calendar-plus me-2"></i> Assign Tasks
                                </a>
                    </li>
                    <li class="nav-item mb-2 admin-only">
                        <a href="#" class="nav-link" data-page="admin-task-history-page">
                            <i class="fa-solid fa-list-alt me-2"></i> Task History
                        </a>
                    </li>
                    <li class="nav-item mb-2 admin-only">
                        <a href="#" class="nav-link" data-page="admin-panel-page">
                            <i class="fa-solid fa-user-gear me-2"></i> Admin Panel
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a href="#" class="nav-link" data-page="profile-page">
                            <i class="fa-solid fa-user me-2"></i> Profile
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" id="logout-btn">
                            <i class="fa-solid fa-right-from-bracket me-2"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="main-content">
                <nav class="navbar navbar-top">
                    <button class="btn btn-outline-secondary d-lg-none" id="sidebar-toggle">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                    <h4 class="mb-0" id="page-title">Dashboard</h4>
                    <div class="d-flex align-items-center">
                        <i class="fa-solid fa-circle-user fa-2x me-2"></i>
                        <span id="user-display-name" class="fw-bold"></span>
                    </div>
                </nav>

                <div class="container-fluid">
                    <div id="dashboard-page" class="content-page">
                        <div id="dashboard-content"></div>
                    </div>
                </div>
                
                <div id="tasks-page" class="content-page d-none">
                    <h2 class="mb-4">My Tasks</h2>
                    <div id="tasks-list" class="row g-4">
                        <p class="text-center">Loading tasks...</p>
                    </div>
                </div>

                <div id="certificates-page" class="content-page d-none">
                    <h2 class="mb-4">My Certificates</h2>
                    <div id="certificate-history-list">
                        <p class="text-center">Loading certificates...</p>
                    </div>
                    <div id="certificate-modal-container" class="d-none">
                        <div id="certificate-content-modal" class="certificate-container mt-4"></div>
                        <div class="text-center mt-3">
                            <button class="btn btn-primary" id="download-cert-modal-btn">Download as PDF</button>
                            <button class="btn btn-secondary" id="close-cert-modal-btn">Close</button>
                        </div>
                    </div>
                </div>

                <div id="add-task-page" class="content-page d-none">
                    <div class="card p-4">
                        <h2 class="mb-4">Add Your Own Task</h2>
                        <div id="add-task-alert-container"></div>
                        <form id="add-task-form">
                            <div id="employee-targets-container">
                                <div class="mb-3 employee-target-input-group">
                                    <label for="employee-task-1" class="form-label">Task 1</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control employee-task-input" required>
                                        <button class="btn btn-outline-danger employee-remove-target-btn" type="button" disabled><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary mb-3" id="add-employee-target-btn">Add More Task</button>
                            <button type="submit" class="btn btn-primary w-100">Submit for Approval</button>
                        </form>
                    </div>
                </div>
                
                <div id="create-team-page" class="content-page d-none">
                    <div class="card p-4">
                        <h2 class="mb-4">Create Your Team</h2>
                        <div id="team-alert-container"></div>
                        <form id="create-team-form">
                            <div class="mb-3">
                                <label for="team-members-select" class="form-label">Select Employees</label>
                                <select class="form-select" id="team-members-select" multiple size="10"></select>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Team</button>
                        </form>
                        <hr class="my-4">
                        <h4 class="mb-3">Current Team Members</h4>
                        <div id="current-team-list" class="list-group">
                            <p class="text-center">No team members saved yet.</p>
                        </div>
                    </div>
                </div>

                <div id="assign-tasks-page" class="content-page d-none">
                    <div class="card p-4">
                        <h2 class="mb-4">Assign Daily Tasks</h2>
                        <div id="assign-tasks-alert-container"></div>
                        <form id="assign-tasks-form">
                            <div class="mb-3">
                                <label for="assign-team-member-select" class="form-label">Select Team Member</label>
                                <select class="form-select" id="assign-team-member-select" required></select>
                            </div>
                            <div class="mb-3">
                                <label for="assign-date-input" class="form-label">Task Date</label>
                                <input type="date" class="form-control" id="assign-date-input" required>
                            </div>
                            <div id="targets-container">
                                <div class="mb-3 target-input-group">
                                    <label for="target-1" class="form-label">Task 1</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control target-input" required>
                                        <select class="form-select priority-select">
                                            <option value="low">Low Priority</option>
                                            <option value="medium" selected>Medium Priority</option>
                                            <option value="high">High Priority</option>
                                        </select>
                                        <button class="btn btn-outline-danger remove-target-btn" type="button" disabled><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary mb-3" id="add-target-btn">Add More Task</button>
                            <button type="submit" class="btn btn-primary d-block w-100">Assign Tasks</button>
                        </form>
                    </div>
                </div>
                
                <div id="review-tasks-page" class="content-page d-none">
                    <div class="card p-4">
                        <h2 class="mb-4">Review Employee Tasks</h2>
                        <div id="review-tasks-alert-container"></div>
                        <div id="pending-tasks-list" class="list-group">
                            <p class="text-center">No tasks pending for approval.</p>
                        </div>
                    </div>
                </div>
                
                <div id="manager-task-history-page" class="content-page d-none">
                    <h2 class="mb-4">Team Task History</h2>
                    <div id="manager-history-list" class="row g-4">
                        <p class="text-center">Loading task history...</p>
                    </div>
                </div>

                <div id="admin-task-history-page" class="content-page d-none">
                    <h2 class="mb-4">All Task History</h2>
                    <div class="card p-4">
                        <div class="mb-3">
                            <label for="history-filter-user" class="form-label">Filter by User</label>
                            <select class="form-select" id="history-filter-user"></select>
                        </div>
                        <div class="mb-3">
                            <label for="history-filter-date" class="form-label">Filter by Date</label>
                            <input type="date" class="form-control" id="history-filter-date">
                        </div>
                        <div id="admin-history-list" class="row g-4 mt-3">
                            <p class="text-center">Loading task history...</p>
                        </div>
                    </div>
                </div>

                <div id="assign-tasks-admin-page" class="content-page d-none">
                    <div class="card p-4">
                        <h2 class="mb-4">Assign Tasks to Any User</h2>
                        <div id="assign-tasks-admin-alert-container"></div>
                        <form id="assign-tasks-admin-form">
                            <div class="mb-3">
                                <label for="assign-user-admin-select" class="form-label">Select User</label>
                                <select class="form-select" id="assign-user-admin-select" required></select>
                            </div>
                            <div class="mb-3">
                                <label for="assign-date-admin-input" class="form-label">Task Date</label>
                                <input type="date" class="form-control" id="assign-date-admin-input" required>
                            </div>
                            <div id="targets-admin-container">
                                <div class="mb-3 target-input-group">
                                    <label for="target-1" class="form-label">Task 1</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control target-input" required>
                                        <select class="form-select priority-select">
                                            <option value="low">Low Priority</option>
                                            <option value="medium">Medium Priority</option>
                                            <option value="high">High Priority</option>
                                        </select>
                                        <button class="btn btn-outline-danger remove-target-btn" type="button" disabled><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary mb-3" id="add-target-admin-btn">Add More Task</button>
                            <button type="submit" class="btn btn-primary d-block w-100">Assign Tasks</button>
                        </form>
                    </div>
                </div>

                <div id="admin-panel-page" class="content-page d-none">
                    <div class="card p-4">
                        <h2 class="mb-4">User & Role Management</h2>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="user-select" class="form-label">Select a User</label>
                                <select class="form-select" id="user-select"></select>
                            </div>
                        </div>
                        <div id="user-details-panel" class="d-none">
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <h4 class="mb-3">Performance Metrics</h4>
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <p class="mb-1"><strong>Total Tasks Given:</strong> <span id="tasks-given-count">0</span></p>
                                            <p class="mb-1"><strong>Tasks Completed:</strong> <span id="tasks-completed-count">0</span></p>
                                            <p class="mb-1"><strong>Efficiency:</strong> <span id="efficiency-rate">0%</span> (<span id="efficiency-rating">N/A</span>)</p>
                                        </div>
                                    </div>
                                    <div class="card mb-3">
                                        <div class="card-body text-center">
                                            <canvas id="completion-chart" width="200" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h4 class="mb-3">Assign Role</h4>
                                    <div id="role-alert-container"></div>
                                    <div class="input-group mb-3">
                                        <select class="form-select" id="role-select">
                                            <option value="employee">Employee</option>
                                            <option value="manager">Manager</option>
                                            <option value="admin">Admin</option>
                                        </select>
                                        <button class="btn btn-primary" type="button" id="assign-role-btn">Assign Role</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="my-4">
                        <h2 class="mb-4">Appreciation Certificate</h2>
                        <div id="certificate-generator-section">
                            <div id="certificate-alert-container"></div>
                            <div class="mb-3">
                                <label for="employee-of-month-select" class="form-label">Select Employee of the Month (Based on Efficiency)</label>
                                <select class="form-select" id="employee-of-month-select">
                                    <option value="" disabled selected>No "Excellent" employees found</option>
                                </select>
                            </div>
                            <button class="btn btn-success" id="generate-certificate-btn">Generate Certificate</button>
                            <div id="certificate-preview-container" class="mt-4 d-none">
                                <div id="certificate-content" class="certificate-container">
                                    <div class="row align-items-center mb-4">
                                        <div class="col-12 text-center">
                                            <img src="https://images.ctfassets.net/5mphie6fobc7/IsAaWI4JColCBz0qBBPPX/1ea834e3319d32b1e78e56cd9887ce90/ChatGPT_Image_Jun_24__2025__10_47_28_AM.png" alt="Maheshwari Computers Logo" class="certificate-logo">
                                        </div>
                                    </div>
                                    <hr style="border-top: 2px solid #0d6efd;">
                                    <h1 class="certificate-header">Appreciation Certificate</h1>
                                    <h5 class="text-muted">(EMPLOYEE OF THE MONTH)</h5>
                                    <p class="certificate-text mt-5">
                                        This is to certify that <span id="cert-employee-name" class="fw-bold"></span> has been recognized as
                                        the Employee of the Month for the month of <span id="cert-month" class="fw-bold"></span> at Maheshwari
                                        Computers Private Limited (MCPL).
                                    </p>
                                    <p class="certificate-text">
                                        He/She has shown exemplary performance, dedication, and sincerity in site work execution and has significantly contributed to the successful progress of our projects.
                                    </p>
                                    <p class="certificate-text">
                                        We truly appreciate his/her hard work, commitment, and valuable efforts.
                                    </p>
                                    <div class="certificate-signature">
                                        <p>Date: <span id="cert-date"></span></p>
                                        <p class="mt-4">Issued By:</p>
                                        <p>MAHESHWARI COMPUTERS PVT. LTD. (MCPL)</p>
                                    </div>
                                </div>
                                <div class="mt-3 text-center">
                                    <button class="btn btn-primary" id="download-cert-btn">Download as PDF</button>
                                    <button class="btn btn-success" id="send-cert-btn">Send as Email</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="profile-page" class="content-page d-none">
                    <div class="card p-4">
                        <h2 class="mb-4">My Profile</h2>
                        <div id="profile-alert-container"></div>
                        <form id="profile-form">
                            <div class="mb-3">
                                <label for="profile-name" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="profile-name" required>
                            </div>
                            <div class="mb-3">
                                <label for="profile-employee-id" class="form-label">Employee ID (pocketHR)</label>
                                <input type="text" class="form-control" id="profile-employee-id" disabled>
                            </div>
                            <div class="mb-3">
                                <label for="profile-location" class="form-label">Location</label>
                                <input type="text" class="form-control" id="profile-location" required>
                            </div>
                            <div class="mb-3">
                                <label for="profile-project" class="form-label">Project Name</label>
                                <input type="text" class="form-control" id="profile-project" required>
                            </div>
                            <div class="mb-3">
                                <label for="profile-mobile" class="form-label">Mobile Number</label>
                                <input type="tel" class="form-control" id="profile-mobile" required>
                            </div>
                            <div class="mb-3">
                                <label for="profile-email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="profile-email" disabled>
                            </div>
                            <div class="mb-3">
                                <label for="profile-role" class="form-label">Role</label>
                                <input type="text" class="form-control" id="profile-role" disabled>
                            </div>
                            <button type="submit" class="btn btn-primary">Update Profile</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getDatabase, ref, set, get, child, onValue, update, push, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-messaging.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDjzKZOgCjjCDBH2q8kpuNRFGMkLFPA4m0",
            authDomain: "staff-jms.firebaseapp.com",
            databaseURL: "https://staff-jms-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "staff-jms",
            storageBucket: "staff-jms.firebasestorage.app",
            messagingSenderId: "127509104745",
            appId: "1:127509104745:web:64e7c71d596a8668003af8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const messaging = getMessaging(app);

        // UI Element References
        const authPages = document.getElementById('auth-pages');
        const mainApp = document.getElementById('main-app');
        const loginPage = document.getElementById('login-page');
        const registerPage = document.getElementById('register-page');
        const forgotPasswordPage = document.getElementById('forgot-password-page');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const registerEmployeeIdInput = document.getElementById('register-employee-id');
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        const loginAlertContainer = document.getElementById('login-alert-container');
        const registerAlertContainer = document.getElementById('register-alert-container');
        const forgotPasswordAlertContainer = document.getElementById('forgot-password-alert-container');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
        const sidebarMenu = document.getElementById('sidebar-menu');
        const pageTitle = document.getElementById('page-title');
        const userDisplayName = document.getElementById('user-display-name');
        const logoutBtn = document.getElementById('logout-btn');
        const dashboardPage = document.getElementById('dashboard-page');
        const dashboardContent = document.getElementById('dashboard-content');
        const tasksPage = document.getElementById('tasks-page');
        const tasksList = document.getElementById('tasks-list');
        const certificatesPage = document.getElementById('certificates-page');
        const certificateHistoryList = document.getElementById('certificate-history-list');
        const certificateModalContainer = document.getElementById('certificate-modal-container');
        const certificateContentModal = document.getElementById('certificate-content-modal');
        const downloadCertModalBtn = document.getElementById('download-cert-modal-btn');
        const closeCertModalBtn = document.getElementById('close-cert-modal-btn');
        const addTasksPage = document.getElementById('add-task-page');
        const addTaskForm = document.getElementById('add-task-form');
        const addTaskAlertContainer = document.getElementById('add-task-alert-container');
        const employeeTargetsContainer = document.getElementById('employee-targets-container');
        const addEmployeeTargetBtn = document.getElementById('add-employee-target-btn');
        const createTeamPage = document.getElementById('create-team-page');
        const createTeamForm = document.getElementById('create-team-form');
        const teamMembersSelect = document.getElementById('team-members-select');
        const currentTeamList = document.getElementById('current-team-list');
        const assignTasksPage = document.getElementById('assign-tasks-page');
        const assignTasksForm = document.getElementById('assign-tasks-form');
        const assignTeamMemberSelect = document.getElementById('assign-team-member-select');
        const targetsContainer = document.getElementById('targets-container');
        const addTargetBtn = document.getElementById('add-target-btn');
        const assignDateInput = document.getElementById('assign-date-input');
        const assignTasksAdminPage = document.getElementById('assign-tasks-admin-page');
        const assignTasksAdminForm = document.getElementById('assign-tasks-admin-form');
        const assignUserAdminSelect = document.getElementById('assign-user-admin-select');
        const targetsAdminContainer = document.getElementById('targets-admin-container');
        const addTargetAdminBtn = document.getElementById('add-target-admin-btn');
        const assignDateAdminInput = document.getElementById('assign-date-admin-input');
        const reviewTasksPage = document.getElementById('review-tasks-page');
        const pendingTasksList = document.getElementById('pending-tasks-list');
        const reviewTasksNotification = document.getElementById('review-tasks-notification');
        const managerTaskHistoryPage = document.getElementById('manager-task-history-page');
        const managerHistoryList = document.getElementById('manager-history-list');
        const adminTaskHistoryPage = document.getElementById('admin-task-history-page');
        const historyFilterUser = document.getElementById('history-filter-user');
        const historyFilterDate = document.getElementById('history-filter-date');
        const adminHistoryList = document.getElementById('admin-history-list');
        const adminPanelPage = document.getElementById('admin-panel-page');
        const userSelect = document.getElementById('user-select');
        const userDetailsPanel = document.getElementById('user-details-panel');
        const assignRoleBtn = document.getElementById('assign-role-btn');
        const roleSelect = document.getElementById('role-select');
        const tasksGivenCount = document.getElementById('tasks-given-count');
        const tasksCompletedCount = document.getElementById('tasks-completed-count');
        const efficiencyRate = document.getElementById('efficiency-rate');
        const efficiencyRating = document.getElementById('efficiency-rating');
        const completionChartCtx = document.getElementById('completion-chart');
        let completionChart;
        const profilePage = document.getElementById('profile-page');
        const profileForm = document.getElementById('profile-form');
        const profileNameInput = document.getElementById('profile-name');
        const profileEmployeeIdInput = document.getElementById('profile-employee-id');
        const profileMobileInput = document.getElementById('profile-mobile');
        const profileEmailInput = document.getElementById('profile-email');
        const profileLocationInput = document.getElementById('profile-location');
        const profileProjectInput = document.getElementById('profile-project');
        const profileRoleInput = document.getElementById('profile-role');
        const employeeOfMonthSelect = document.getElementById('employee-of-month-select');
        const generateCertificateBtn = document.getElementById('generate-certificate-btn');
        const certificatePreviewContainer = document.getElementById('certificate-preview-container');
        const certificateContent = document.getElementById('certificate-content');
        const certEmployeeName = document.getElementById('cert-employee-name');
        const certMonth = document.getElementById('cert-month');
        const certDate = document.getElementById('cert-date');
        const downloadCertBtn = document.getElementById('download-cert-btn');
        const sendCertBtn = document.getElementById('send-cert-btn');
        
        let currentCertData = null;
        let allUsersData = {};
        
        const tasksForApprovalRef = ref(db, 'employee_tasks_for_approval');
        const assignedTasksRef = ref(db, 'assigned_tasks');
        const usersRef = ref(db, 'users');
        const deviceTokensRef = ref(db, 'device_tokens');

        // Utility functions
        function showPage(pageId) {
            document.querySelectorAll('.content-page').forEach(page => page.classList.add('d-none'));
            document.getElementById(pageId).classList.remove('d-none');
            const pageLink = document.querySelector(`[data-page="${pageId}"]`);
            pageTitle.textContent = pageLink.textContent.trim();
            document.querySelectorAll('.sidebar a').forEach(link => link.classList.remove('active'));
            pageLink.classList.add('active');
            
            // Hide sidebar on mobile when a link is clicked
            const isDesktop = window.matchMedia("(min-width: 769px)").matches;
            if (!isDesktop) {
                sidebar.classList.remove('show');
            }
        }

        function showAlert(container, message, type = 'danger') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.role = 'alert';
            alert.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
            container.innerHTML = '';
            container.appendChild(alert);
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 5000);
        }

        function getCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function getMonthName(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('default', { month: 'long', year: 'numeric' });
        }
        
        function getPriorityColor(priority) {
            switch(priority) {
                case 'high': return 'danger';
                case 'medium': return 'warning';
                case 'low': return 'success';
                default: return 'secondary';
            }
        }
        
        function updateRemoveButtons(container) {
            const removeBtns = container.querySelectorAll('.remove-target-btn, .employee-remove-target-btn');
            removeBtns.forEach(btn => {
                btn.disabled = removeBtns.length === 1;
            });
        }
        
        function toggleSidebar() {
            const isDesktop = window.matchMedia("(min-width: 769px)").matches;
            if (isDesktop) {
                // For desktop, toggle the 'collapsed' class on the sidebar
                sidebar.classList.toggle('collapsed');
            } else {
                // For mobile, toggle the 'show' class on the sidebar
                sidebar.classList.toggle('show');
            }
        }

        // Push Notification Functions
        async function requestPermissionAndGetToken() {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    const token = await getToken(messaging, {
                        vapidKey: 'BExP8aT6HqO7WwM8mQp4K1gR2z_Yf7D5Ff-zD_yQ7pW-u_Ew8_9vP0_Vw8-z_Yf7D5Ff-zD_yQ7pW-u_Ew8_9vP0_Vw'
                    });
                    console.log('FCM token:', token);
                    return token;
                } else {
                    console.warn('Notification permission denied.');
                    return null;
                }
            } catch (error) {
                console.error('Error getting FCM token:', error);
                return null;
            }
        }

        async function saveDeviceToken(token) {
            const userId = auth.currentUser.uid;
            await set(ref(db, `device_tokens/${userId}`), token);
            console.log('Device token saved successfully.');
        }

        async function sendNotificationToManager(managerId, message) {
            const managerTokenSnapshot = await get(ref(db, `device_tokens/${managerId}`));
            const managerToken = managerTokenSnapshot.val();

            if (managerToken) {
                const payload = {
                    token: managerToken,
                    notification: {
                        title: 'New Task Submission! ðŸ””',
                        body: message
                    }
                };
                // In a real app, you would send this payload to your backend server
                // which would then use a server-side SDK to send the message via FCM.
                // For this example, we'll just log it.
                console.log('Sending notification to manager:', payload);
            }
        }
        
        async function sendNotificationToEmployee(employeeId, message) {
            const employeeTokenSnapshot = await get(ref(db, `device_tokens/${employeeId}`));
            const employeeToken = employeeTokenSnapshot.val();
            
            if (employeeToken) {
                const payload = {
                    token: employeeToken,
                    notification: {
                        title: 'Task Update!',
                        body: message
                    }
                };
                // Same as above, this should be handled by a backend server
                console.log('Sending notification to employee:', payload);
            }
        }

        // Listen for incoming messages while the app is in the foreground
        onMessage(messaging, (payload) => {
            console.log('Foreground message received.', payload);
            const notificationTitle = payload.notification.title;
            const notificationOptions = {
                body: payload.notification.body,
                icon: 'path/to/your/app/logo.png'
            };
            new Notification(notificationTitle, notificationOptions);
        });

        // Authentication and User State Management
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                authPages.classList.add('d-none');
                mainApp.classList.remove('d-none');
                
                const userRef = ref(db, `users/${user.uid}`);
                const snapshot = await get(userRef);
                let userData = snapshot.val();
                
                if (user.email === 'admin2025@gmail.com' && (!userData || userData.role !== 'admin')) {
                    await set(userRef, {
                        name: 'Admin',
                        email: 'admin2025@gmail.com',
                        role: 'admin',
                        employeeId: 'ADMIN001'
                    });
                    user.role = 'admin';
                    userData = { name: 'Admin', email: 'admin2025@gmail.com', role: 'admin', employeeId: 'ADMIN001' };
                } else if (userData) {
                    user.role = userData.role || 'employee';
                } else {
                    user.role = 'employee';
                }
                
                userDisplayName.textContent = userData ? userData.name : user.displayName;
                await fetchAllUsers();
                await updateUIBasedOnRole(user.role);
                showPage('dashboard-page');

                // Request notification permission and save token on login
                const token = await requestPermissionAndGetToken();
                if (token) {
                    await saveDeviceToken(token);
                }

            } else {
                authPages.classList.remove('d-none');
                mainApp.classList.add('d-none');
                showAuthPage('login-page');
            }
        });

        function showAuthPage(pageId) {
            loginPage.classList.add('d-none');
            registerPage.classList.add('d-none');
            forgotPasswordPage.classList.add('d-none');
            document.getElementById(pageId).classList.remove('d-none');
        }
        
        async function fetchAllUsers() {
            const snapshot = await get(usersRef);
            allUsersData = snapshot.val() || {};
        }

        async function getUserNameById(uid) {
            if (allUsersData[uid]) {
                return allUsersData[uid].name;
            }
            const userSnapshot = await get(child(usersRef, uid));
            if (userSnapshot.exists()) {
                const userData = userSnapshot.val();
                allUsersData[uid] = userData;
                return userData.name;
            }
            return 'Unknown User';
        }

        async function updateUIBasedOnRole(role) {
            document.querySelectorAll('.employee-only, .manager-only, .admin-only').forEach(el => el.classList.add('d-none'));
            document.querySelectorAll('.sidebar a').forEach(link => link.classList.remove('active'));
            
            dashboardContent.innerHTML = '';
            const reviewTasksMenuItem = document.querySelector('[data-page="review-tasks-page"]');

            if (role === 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('d-none'));
                await loadAdminDashboard();
            } else if (role === 'manager') {
                document.querySelectorAll('.manager-only').forEach(el => el.classList.remove('d-none'));
                
                // Set up real-time listener for pending tasks
                onValue(tasksForApprovalRef, (snapshot) => {
                    const tasksData = snapshot.val() || {};
                    const hasPendingTasks = Object.values(tasksData).some(task => task.status === 'pending-approval');
                    if (hasPendingTasks) {
                        reviewTasksNotification.classList.remove('d-none');
                    } else {
                        reviewTasksNotification.classList.add('d-none');
                    }
                });

                await loadManagerDashboard();
            } else { // employee
                document.querySelectorAll('.employee-only').forEach(el => el.classList.remove('d-none'));
                dashboardContent.innerHTML = `
                    <h3 class="mb-4">Hello, ${userDisplayName.textContent}! ðŸ‘‹</h3>
                    <div class="card p-4">
                        <div class="card-header bg-white">
                            <h4 class="card-title">Your Team's Today's Progress</h4>
                        </div>
                        <div class="card-body" id="employee-dashboard-progress">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><strong>DHRUV PANCHAL</strong></span>
                                <span>6 / 6 Tasks Completed</span>
                            </div>
                        </div>
                    </div>
                `;
                await loadTasks();
            }
        }
        
        // --- Event Listeners ---
        document.getElementById('create-account-link').addEventListener('click', (e) => { e.preventDefault(); showAuthPage('register-page'); });
        document.getElementById('back-to-login-link').addEventListener('click', (e) => { e.preventDefault(); showAuthPage('login-page'); });
        document.getElementById('forgot-password-link').addEventListener('click', (e) => { e.preventDefault(); showAuthPage('forgot-password-page'); });
        document.getElementById('back-to-login-link2').addEventListener('click', (e) => { e.preventDefault(); showAuthPage('login-page'); });
        
        sidebarMenu.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link && link.dataset.page) {
                e.preventDefault();
                const pageId = link.dataset.page;
                showPage(pageId);
                // Dynamically load page content
                if (pageId === 'tasks-page') loadTasks();
                if (pageId === 'certificates-page') loadCertificates();
                if (pageId === 'create-team-page') loadEmployeesForTeam();
                if (pageId === 'assign-tasks-page') loadManagerTeamForAssign();
                if (pageId === 'assign-tasks-admin-page') loadAllUsersForAdminAssign();
                if (pageId === 'review-tasks-page') loadPendingTasks();
                if (pageId === 'manager-task-history-page') loadManagerTaskHistory();
                if (pageId === 'admin-task-history-page') loadAllTaskHistory();
                if (pageId === 'admin-panel-page') loadAllUsersForAdmin();
                if (pageId === 'profile-page') loadProfile();
            }
        });
        
        sidebarToggle.addEventListener('click', toggleSidebar);
        
        sidebarCloseBtn.addEventListener('click', () => {
            sidebar.classList.add('collapsed');
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showAlert(loginAlertContainer, `Login failed: ${error.message}`);
            }
        });
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = registerForm['register-name'].value;
            const employeeId = registerForm['register-employee-id'].value;
            const location = registerForm['register-location'].value;
            const project = registerForm['register-project'].value;
            const mobile = registerForm['register-mobile'].value;
            const email = registerForm['register-email'].value;
            const password = registerForm['register-password'].value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await set(ref(db, `users/${user.uid}`), {
                    name: name,
                    employeeId: employeeId,
                    location: location,
                    project: project,
                    mobile: mobile,
                    email: email,
                    role: 'employee'
                });
                await updateProfile(user, { displayName: name });
                showAlert(registerAlertContainer, 'Account created successfully! Please log in.', 'success');
                setTimeout(() => showAuthPage('login-page'), 2000);
            } catch (error) {
                showAlert(registerAlertContainer, `Registration failed: ${error.message}`);
            }
        });
        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = forgotPasswordForm['forgot-password-email'].value;
            try {
                await sendPasswordResetEmail(auth, email);
                showAlert(forgotPasswordAlertContainer, 'Password reset email sent!', 'success');
            } catch (error) {
                showAlert(forgotPasswordAlertContainer, `Error: ${error.message}`);
            }
        });
        logoutBtn.addEventListener('click', () => signOut(auth));

        // Employee Task Management
        async function loadTasks() {
            tasksList.innerHTML = '<p class="text-center">Loading tasks...</p>';
            const userId = auth.currentUser.uid;
            
            onValue(assignedTasksRef, async (assignedSnapshot) => {
                onValue(tasksForApprovalRef, async (pendingSnapshot) => {
                    const assignedTasksData = assignedSnapshot.val() || {};
                    const pendingTasksData = pendingSnapshot.val() || {};
                    
                    const allTasks = [];
                    Object.entries(assignedTasksData).forEach(([key, task]) => {
                        if (task.userId === userId) {
                            allTasks.push({ taskId: key, ...task, type: 'assigned' });
                        }
                    });
                    Object.entries(pendingTasksData).forEach(([key, task]) => {
                        if (task.userId === userId) {
                            allTasks.push({ taskId: key, ...task, type: 'pending' });
                        }
                    });
                    
                    tasksList.innerHTML = '';
                    if (allTasks.length > 0) {
                        const tasksByDate = {};
                        for (const task of allTasks) {
                            const date = task.date;
                            if (!tasksByDate[date]) {
                                tasksByDate[date] = {
                                    assignedTasks: [],
                                    pendingTasks: [],
                                    assignedBy: task.managerId || 'admin2025@gmail.com'
                                };
                            }
                            if (task.type === 'assigned') {
                                tasksByDate[date].assignedTasks.push(task);
                            } else if (task.type === 'pending') {
                                tasksByDate[date].pendingTasks.push(task);
                            }
                        }

                        const sortedDates = Object.keys(tasksByDate).sort().reverse();
                        
                        for (const date of sortedDates) {
                            const dateSection = document.createElement('div');
                            dateSection.className = 'col-12 mb-4';
                            const isToday = date === getCurrentDate();
                            const assignedByName = await getUserNameById(tasksByDate[date].assignedBy);
                            
                            dateSection.innerHTML = `
                                <div class="card">
                                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                        <h4 class="mb-0">${isToday ? 'Today' : date}</h4>
                                        <small>Assigned by: ${assignedByName}</small>
                                    </div>
                                    <ul class="list-group list-group-flush">
                                        ${tasksByDate[date].assignedTasks.map(task => {
                                            let targetsHtml = '';
                                            if (typeof task.targets === 'object' && !Array.isArray(task.targets)) {
                                                targetsHtml = Object.entries(task.targets).map(([targetId, target]) => `
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <span class="badge bg-${getPriorityColor(target.priority)}">${target.priority} Priority</span>
                                                            <span class="${target.completed ? 'text-decoration-line-through text-muted' : ''}">${target.description}</span>
                                                        </div>
                                                        <div class="text-end">
                                                            <span class="badge bg-${target.completed ? 'success' : 'warning'} me-2">${target.completed ? 'Completed' : 'Pending'}</span>
                                                            ${!target.completed ? `<button class="btn btn-sm btn-primary mark-target-btn" data-task-id="${task.taskId}" data-target-id="${targetId}">Mark Complete</button>` : ''}
                                                        </div>
                                                    </li>
                                                `).join('');
                                            }
                                            return targetsHtml;
                                        }).join('')}
                                        ${tasksByDate[date].pendingTasks.map(task => `
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <span class="badge bg-secondary">Self-Assigned</span>
                                                    <span>${task.task}</span>
                                                </div>
                                                <span class="badge bg-info">${task.status === 'pending-approval' ? 'Pending Approval' : task.status}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            `;
                            tasksList.appendChild(dateSection);
                        }

                        document.querySelectorAll('.mark-target-btn').forEach(button => {
                            button.addEventListener('click', async (e) => {
                                const taskId = e.target.dataset.taskId;
                                const targetId = e.target.dataset.targetId;
                                const targetRef = ref(db, `assigned_tasks/${taskId}/targets/${targetId}`);
                                await update(targetRef, { completed: true });
                                
                                // Find the manager ID to send notification
                                const taskSnapshot = await get(ref(db, `assigned_tasks/${taskId}`));
                                const taskData = taskSnapshot.val();
                                if (taskData && taskData.managerId) {
                                    sendNotificationToManager(taskData.managerId, `${userDisplayName.textContent} has completed a task!`);
                                }
                            });
                        });
                    } else {
                        tasksList.innerHTML = '<div class="col-12"><p class="text-center">No tasks assigned or pending.</p></div>';
                    }
                });
            });
        }
        
        // Employee Certificates
        async function loadCertificates() {
            certificateHistoryList.innerHTML = '<p class="text-center">Loading certificates...</p>';
            certificateModalContainer.classList.add('d-none');
            const userId = auth.currentUser.uid;
            const certsRef = ref(db, `certificates/${userId}`);

            const snapshot = await get(certsRef);
            const certsData = snapshot.val();

            if (certsData) {
                let count = 0;
                certificateHistoryList.innerHTML = `<p class="fw-bold">Total Certificates: ${Object.keys(certsData).length}</p><hr>`;
                
                Object.entries(certsData).forEach(([certId, cert]) => {
                    count++;
                    const card = document.createElement('div');
                    card.className = 'card mb-3';
                    card.innerHTML = `
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <span>Certificate #${count} - ${cert.date}</span>
                            <div>
                                <button class="btn btn-sm btn-info view-cert-btn me-2" data-cert='${JSON.stringify(cert)}'>View</button>
                                <button class="btn btn-sm btn-primary download-cert-btn" data-cert='${JSON.stringify(cert)}'>Download</button>
                            </div>
                        </div>
                    `;
                    certificateHistoryList.appendChild(card);
                });
                
                document.querySelectorAll('.view-cert-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const cert = JSON.parse(e.target.dataset.cert);
                        showCertificate(cert);
                    });
                });
                document.querySelectorAll('.download-cert-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const cert = JSON.parse(e.target.dataset.cert);
                        downloadCertificate(cert);
                    });
                });
            } else {
                certificateHistoryList.innerHTML = '<p class="text-center">You have not received any certificates yet.</p>';
            }
        }
        
        function showCertificate(certData) {
            certEmployeeName.textContent = `Mr./Ms. ${certData.employeeName}`;
            certMonth.textContent = getMonthName(certData.date);
            certDate.textContent = getCurrentDate();
            certificateModalContainer.classList.remove('d-none');
            currentCertData = certData;
        }

        closeCertModalBtn.addEventListener('click', () => {
            certificateModalContainer.classList.add('d-none');
        });
        downloadCertModalBtn.addEventListener('click', () => {
            if(currentCertData) {
                downloadCertificate(currentCertData);
            }
        });

        // Employee Add Task
        function createEmployeeTargetInputGroup(count) {
            const container = document.createElement('div');
            container.className = 'mb-3 employee-target-input-group';
            container.innerHTML = `
                <label for="employee-task-1" class="form-label">Task 1</label>
                <div class="input-group">
                    <input type="text" class="form-control employee-task-input" required>
                    <button class="btn btn-outline-danger employee-remove-target-btn" type="button" disabled><i class="fa-solid fa-trash"></i></button>
                </div>
            `;
            return container;
        }

        addEmployeeTargetBtn.addEventListener('click', () => {
            const targetCount = employeeTargetsContainer.querySelectorAll('.employee-target-input-group').length + 1;
            employeeTargetsContainer.appendChild(createEmployeeTargetInputGroup(targetCount));
            updateRemoveButtons(employeeTargetsContainer);
        });

        employeeTargetsContainer.addEventListener('click', (e) => {
            if (e.target.closest('.employee-remove-target-btn')) {
                const targetGroup = e.target.closest('.employee-target-input-group');
                if (employeeTargetsContainer.querySelectorAll('.employee-target-input-group').length > 1) {
                    targetGroup.remove();
                    updateRemoveButtons(employeeTargetsContainer);
                }
            }
        });

        addTaskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            const taskInputs = employeeTargetsContainer.querySelectorAll('.employee-task-input');
            const tasks = Array.from(taskInputs).map(input => input.value.trim()).filter(Boolean);

            if (tasks.length === 0) {
                showAlert(addTaskAlertContainer, 'Please add at least one task.', 'danger');
                return;
            }

            try {
                // Find manager for the current user
                const usersSnapshot = await get(ref(db, 'users'));
                const usersData = usersSnapshot.val();
                let managerId = null;
                for (const mId in usersData) {
                    const teamSnapshot = await get(ref(db, `teams/${mId}`));
                    const team = teamSnapshot.val() || {};
                    if (Object.values(team).includes(user.uid)) {
                        managerId = mId;
                        break;
                    }
                }
                
                for (const task of tasks) {
                    const newTaskRef = push(tasksForApprovalRef);
                    await set(newTaskRef, {
                        userId: user.uid,
                        task: task,
                        status: 'pending-approval',
                        date: getCurrentDate(),
                        submittedBy: {
                            name: user.displayName,
                            uid: user.uid
                        }
                    });
                }

                // Send notification to manager
                if (managerId) {
                    sendNotificationToManager(managerId, `${userDisplayName.textContent} has submitted new tasks for your approval.`);
                }
                
                showAlert(addTaskAlertContainer, 'Tasks submitted for approval!', 'success');
                addTaskForm.reset();
                employeeTargetsContainer.innerHTML = createEmployeeTargetInputGroup(1).outerHTML;
                updateRemoveButtons(employeeTargetsContainer);
            } catch (error) {
                showAlert(addTaskAlertContainer, `Failed to submit tasks: ${error.message}`);
            }
        });

        // Manager Dashboard
        async function loadManagerDashboard() {
            dashboardContent.innerHTML = `
                <h3 class="mb-4">Hello, ${userDisplayName.textContent}! ðŸ‘‹</h3>
                <div class="row g-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">Your Team's Today's Progress</div>
                            <div class="card-body" id="manager-progress-list">
                                <p class="text-center">Loading team progress...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const managerProgressList = document.getElementById('manager-progress-list');
            const managerId = auth.currentUser.uid;
            const today = getCurrentDate();
            
            const teamRef = ref(db, `teams/${managerId}`);

            onValue(teamRef, async (teamSnapshot) => {
                const teamData = teamSnapshot.val() || {};
                const teamUids = Object.values(teamData);
                if (teamUids.length === 0) {
                    managerProgressList.innerHTML = '<p class="text-center">You have no team members. Go to "My Team" to add them.</p>';
                    return;
                }
                
                onValue(assignedTasksRef, async (tasksSnapshot) => {
                    const tasksData = tasksSnapshot.val() || {};
                    let outputHtml = '';
                    
                    for (const uid of teamUids) {
                        const user = allUsersData[uid];
                        if (!user) continue;
                        
                        const userTasks = Object.values(tasksData).filter(t => t.userId === uid && t.date === today);
                        let completedCount = 0;
                        let totalCount = 0;
                        userTasks.forEach(task => {
                            if (task.targets) {
                                Object.values(task.targets).forEach(target => {
                                    totalCount++;
                                    if (target.completed) completedCount++;
                                });
                            }
                        });
                        
                        outputHtml += `
                            <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
                                <span><strong>${user.name}</strong></span>
                                <span>${completedCount} / ${totalCount} Tasks Completed</span>
                            </div>
                        `;
                    }
                    
                    managerProgressList.innerHTML = outputHtml || '<p class="text-center">No tasks assigned to your team today.</p>';
                });
            });
        }
        
        async function loadManagerTaskHistory() {
            managerHistoryList.innerHTML = '<p class="text-center">Loading task history...</p>';
            const managerId = auth.currentUser.uid;
            const teamRef = ref(db, `teams/${managerId}`);
        
            const teamSnapshot = await get(teamRef);
            const teamUids = Object.values(teamSnapshot.val() || {});
        
            if (teamUids.length === 0) {
                managerHistoryList.innerHTML = '<p class="text-center">You have no team members. Go to "My Team" to add them.</p>';
                return;
            }
        
            onValue(assignedTasksRef, async (tasksSnapshot) => {
                const tasksData = tasksSnapshot.val();
                let outputHtml = '';
                const tasksByUserAndDate = {};
        
                Object.entries(tasksData || {}).forEach(([taskId, task]) => {
                    if (teamUids.includes(task.userId)) {
                        const userKey = `${task.userId}_${task.date}`;
                        if (!tasksByUserAndDate[userKey]) {
                            tasksByUserAndDate[userKey] = {
                                userName: allUsersData[task.userId]?.name || 'Unknown User',
                                date: task.date,
                                assignedBy: task.managerId,
                                tasks: []
                            };
                        }
                        tasksByUserAndDate[userKey].tasks.push({ taskId, ...task });
                    }
                });
        
                const sortedUserDates = Object.keys(tasksByUserAndDate).sort((a, b) => {
                    const dateA = tasksByUserAndDate[a].date;
                    const dateB = tasksByUserAndDate[b].date;
                    return dateB.localeCompare(dateA);
                });
                
                for (const userDateKey of sortedUserDates) {
                    const group = tasksByUserAndDate[userDateKey];
                    const assignedByName = await getUserNameById(group.assignedBy);
                    outputHtml += `<div class="col-12 mb-4"><div class="card"><div class="card-header bg-secondary text-white"><h4 class="mb-0">${group.userName} - ${group.date}</h4><small>Assigned by: ${assignedByName}</small></div><ul class="list-group list-group-flush">`;
                    
                    group.tasks.forEach(task => {
                        Object.values(task.targets).forEach(target => {
                            outputHtml += `
                                <li class="list-group-item">
                                    <span class="badge bg-${getPriorityColor(target.priority)} me-2">${target.priority}</span>
                                    ${target.description} 
                                    <span class="badge bg-${target.completed ? 'success' : 'warning'} ms-2">${target.completed ? 'Completed' : 'Pending'}</span>
                                </li>
                            `;
                        });
                    });
                    outputHtml += '</ul></div></div>';
                }
        
                managerHistoryList.innerHTML = outputHtml || '<p class="text-center">No task history found for your team.</p>';
            });
        }

        // Manager Create Team
        async function loadEmployeesForTeam() {
            teamMembersSelect.innerHTML = '';
            
            const snapshot = await get(usersRef);
            const usersData = snapshot.val();
            const employees = Object.entries(usersData || {}).filter(([uid, user]) => user.role === 'employee');

            employees.forEach(([uid, user]) => {
                const option = document.createElement('option');
                option.value = uid;
                option.textContent = `${user.name} - ${user.location || 'N/A'} (${user.project || 'N/A'})`;
                teamMembersSelect.appendChild(option);
            });
            loadCurrentTeam();
        }

        async function loadCurrentTeam() {
            const managerId = auth.currentUser.uid;
            const teamRef = ref(db, `teams/${managerId}`);
            currentTeamList.innerHTML = '<p class="text-center">Loading current team...</p>';

            const snapshot = await get(teamRef);
            const teamData = snapshot.val();
            currentTeamList.innerHTML = '';
            
            if (teamData) {
                const teamMemberUids = Object.values(teamData);
                
                teamMemberUids.forEach(uid => {
                    if (allUsersData[uid]) {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        li.innerHTML = `
                            ${allUsersData[uid].name} - ${allUsersData[uid].location || 'N/A'} (${allUsersData[uid].project || 'N/A'})
                            <button class="btn btn-sm btn-outline-danger remove-member-btn" data-id="${uid}">
                                <i class="fa-solid fa-user-minus"></i> Remove
                            </button>
                        `;
                        currentTeamList.appendChild(li);
                    }
                });
            } else {
                currentTeamList.innerHTML = '<p class="text-center">No team members saved yet.</p>';
            }
        }
        
        createTeamForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const selectedUids = Array.from(teamMembersSelect.selectedOptions).map(option => option.value);
            const managerId = auth.currentUser.uid;
            const teamRef = ref(db, `teams/${managerId}`);
            
            await set(teamRef, selectedUids);
            showAlert(document.getElementById('team-alert-container'), 'Team saved successfully!', 'success');
            loadCurrentTeam();
        });
        
        // Manager Assign Tasks
        async function loadManagerTeamForAssign() {
            const managerId = auth.currentUser.uid;
            const teamRef = ref(db, `teams/${managerId}`);
            assignTeamMemberSelect.innerHTML = '<option value="" disabled selected>Select a Team Member</option>';
            assignDateInput.value = getCurrentDate();
            
            const snapshot = await get(teamRef);
            const teamData = snapshot.val();
            
            if (teamData) {
                const teamMemberUids = Object.values(teamData);
                
                teamMemberUids.forEach(uid => {
                    if (allUsersData[uid]) {
                        const option = document.createElement('option');
                        option.value = uid;
                        option.textContent = `${allUsersData[uid].name} - ${allUsersData[uid].location || 'N/A'} (${allUsersData[uid].project || 'N/A'})`;
                        assignTeamMemberSelect.appendChild(option);
                    }
                });
            } else {
                showAlert(document.getElementById('assign-tasks-alert-container'), 'You have no team members assigned. Go to My Team to create one.', 'warning');
            }
            updateRemoveButtons(targetsContainer);
        }

        function createTargetInputGroup(count) {
            const container = document.createElement('div');
            container.className = 'mb-3 target-input-group';
            container.innerHTML = `
                <label for="target-${count}" class="form-label">Task ${count}</label>
                <div class="input-group">
                    <input type="text" class="form-control target-input" required>
                    <select class="form-select priority-select">
                        <option value="low">Low Priority</option>
                        <option value="medium" selected>Medium Priority</option>
                        <option value="high">High Priority</option>
                    </select>
                    <button class="btn btn-outline-danger remove-target-btn" type="button" disabled><i class="fa-solid fa-trash"></i></button>
                </div>
            `;
            return container;
        }

        addTargetBtn.addEventListener('click', () => {
            const targetCount = targetsContainer.querySelectorAll('.target-input-group').length + 1;
            targetsContainer.appendChild(createTargetInputGroup(targetCount));
            updateRemoveButtons(targetsContainer);
        });
        addTargetAdminBtn.addEventListener('click', () => {
            const targetCount = targetsAdminContainer.querySelectorAll('.target-input-group').length + 1;
            targetsAdminContainer.appendChild(createTargetInputGroup(targetCount));
            updateRemoveButtons(targetsAdminContainer);
        });

        targetsContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-target-btn')) {
                const targetGroup = e.target.closest('.target-input-group');
                if (targetsContainer.querySelectorAll('.target-input-group').length > 1) {
                    targetGroup.remove();
                    updateRemoveButtons(targetsContainer);
                }
            }
        });
        targetsAdminContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-target-btn')) {
                const targetGroup = e.target.closest('.target-input-group');
                if (targetsAdminContainer.querySelectorAll('.target-input-group').length > 1) {
                    targetGroup.remove();
                    updateRemoveButtons(targetsAdminContainer);
                }
            }
        });

        assignTasksForm.addEventListener('submit', (e) => handleTaskAssignment(e, 'assign-tasks-alert-container', assignTeamMemberSelect.value, assignDateInput.value, targetsContainer));
        assignTasksAdminForm.addEventListener('submit', (e) => handleTaskAssignment(e, 'assign-tasks-admin-alert-container', assignUserAdminSelect.value, assignDateAdminInput.value, targetsAdminContainer));

        async function handleTaskAssignment(e, alertContainerId, userId, assignDate, targetsContainer) {
            e.preventDefault();
            const managerId = auth.currentUser.uid;
            const targetInputs = targetsContainer.querySelectorAll('.target-input-group');
            const targets = {};
            targetInputs.forEach((group, index) => {
                const description = group.querySelector('.target-input').value.trim();
                const priority = group.querySelector('.priority-select').value;
                if (description) {
                    const targetId = push(ref(db, 'temp')).key;
                    targets[targetId] = {
                        description,
                        priority,
                        completed: false
                    };
                }
            });
            
            if (Object.keys(targets).length === 0) {
                showAlert(document.getElementById(alertContainerId), 'Please add at least one target.', 'danger');
                return;
            }

            try {
                const newTaskId = push(assignedTasksRef).key;
                await set(ref(db, `assigned_tasks/${newTaskId}`), {
                    managerId: managerId,
                    userId: userId,
                    targets: targets,
                    date: assignDate,
                    status: 'approved'
                });
                showAlert(document.getElementById(alertContainerId), 'Tasks assigned successfully!', 'success');
                e.target.reset();
                targetsContainer.innerHTML = createTargetInputGroup(1).outerHTML;
                updateRemoveButtons(targetsContainer);
            } catch (error) {
                showAlert(document.getElementById(alertContainerId), `Failed to assign tasks: ${error.message}`, 'danger');
            }
        }
        
        // Admin Assign Tasks Page
        async function loadAllUsersForAdminAssign() {
            assignUserAdminSelect.innerHTML = '<option value="" disabled selected>Select a User</option>';
            assignDateAdminInput.value = getCurrentDate();
            
            const snapshot = await get(usersRef);
            const usersData = snapshot.val();
            
            Object.entries(usersData || {}).forEach(([uid, user]) => {
                const option = document.createElement('option');
                option.value = uid;
                option.textContent = `${user.name} (${user.role})`;
                assignUserAdminSelect.appendChild(option);
            });
            updateRemoveButtons(targetsAdminContainer);
        }
        
        // Manager Review Tasks
        async function loadPendingTasks() {
            pendingTasksList.innerHTML = '<p class="text-center">Loading pending tasks...</p>';
            const managerId = auth.currentUser.uid;
            const teamRef = ref(db, `teams/${managerId}`);
            
            const teamSnapshot = await get(teamRef);
            const teamUids = Object.values(teamSnapshot.val() || {});
            
            onValue(tasksForApprovalRef, (tasksSnapshot) => {
                const tasksData = tasksSnapshot.val() || {};
                let outputHtml = '';
                let hasPending = false;
                
                Object.entries(tasksData).forEach(([taskId, task]) => {
                    if (teamUids.includes(task.userId) && task.status === 'pending-approval') {
                        hasPending = true;
                        const user = allUsersData[task.userId] || {};
                        outputHtml += `
                            <div class="list-group-item d-flex justify-content-between align-items-center flex-wrap mb-3">
                                <div>
                                    <h5 class="mb-1">${user.name}</h5>
                                    <p class="mb-1">${task.task}</p>
                                    <p class="small text-muted mb-0">Submitted on: ${task.date}</p>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-success approve-task-btn" data-id="${taskId}" data-user-id="${task.userId}" data-task="${task.task}">Approve</button>
                                    <button class="btn btn-sm btn-danger reject-task-btn" data-id="${taskId}">Reject</button>
                                </div>
                            </div>
                        `;
                    }
                });
                
                pendingTasksList.innerHTML = outputHtml || '<p class="text-center">No tasks pending for approval.</p>';
                
                document.querySelectorAll('.approve-task-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const taskId = e.target.dataset.id;
                        const userId = e.target.dataset.userId;
                        const taskText = e.target.dataset.task;
                        
                        const newAssignedTaskRef = push(assignedTasksRef);
                        const targets = {};
                        const newTargetId = push(ref(db, 'temp')).key;
                        targets[newTargetId] = {
                            description: taskText,
                            priority: 'medium',
                            completed: false
                        };
                        
                        await set(newAssignedTaskRef, {
                            managerId: managerId,
                            userId: userId,
                            targets: targets,
                            date: getCurrentDate(),
                            status: 'approved'
                        });
                        
                        await remove(child(tasksForApprovalRef, taskId));
                        showAlert(document.getElementById('review-tasks-alert-container'), 'Task approved!', 'success');
                        
                        // Send notification to employee
                        sendNotificationToEmployee(userId, `Your task "${taskText}" has been approved!`);
                    });
                });
                
                document.querySelectorAll('.reject-task-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const taskId = e.target.dataset.id;
                        const taskSnapshot = await get(child(tasksForApprovalRef, taskId));
                        const taskData = taskSnapshot.val();
                        
                        await update(child(tasksForApprovalRef, taskId), { status: 'rejected' });
                        showAlert(document.getElementById('review-tasks-alert-container'), 'Task rejected!', 'danger');
                        
                        // Send notification to employee
                        sendNotificationToEmployee(taskData.userId, `Your task "${taskData.task}" was rejected. Please review.`);
                    });
                });
            });
        }
        
        // Admin Dashboard
        async function loadAdminDashboard() {
            dashboardContent.innerHTML = `
                <h3 class="mb-4">Hello, Admin!</h3>
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100 bg-success-subtle border-success">
                            <div class="card-body">
                                <h5 class="card-title text-success">Assigned Users</h5>
                                <p class="card-text">Users who have been assigned at least one task.</p>
                                <ul id="assigned-users-list" class="list-group list-group-flush"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card h-100 bg-warning-subtle border-warning">
                            <div class="card-body">
                                <h5 class="card-title text-warning">Unassigned Users</h5>
                                <p class="card-text">Employees who have not been assigned any tasks yet.</p>
                                <ul id="unassigned-users-list" class="list-group list-group-flush"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const assignedList = document.getElementById('assigned-users-list');
            const unassignedList = document.getElementById('unassigned-users-list');

            assignedList.innerHTML = '<p class="text-center">Loading...</p>';
            unassignedList.innerHTML = '<p class="text-center">Loading...</p>';
            
            const [usersSnapshot, tasksSnapshot] = await Promise.all([
                get(usersRef),
                get(assignedTasksRef)
            ]);

            const usersData = usersSnapshot.val() || {};
            const tasksData = tasksSnapshot.val() || {};
            const assignedUserIds = new Set();

            Object.values(tasksData).forEach(task => assignedUserIds.add(task.userId));

            assignedList.innerHTML = '';
            unassignedList.innerHTML = '';
            
            Object.entries(usersData).forEach(([uid, user]) => {
                if (user.role === 'employee') {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = `${user.name} - ${user.location || 'N/A'} (${user.project || 'N/A'})`;
                    
                    if (assignedUserIds.has(uid)) {
                        assignedList.appendChild(li);
                    } else {
                        unassignedList.appendChild(li);
                    }
                }
            });
            
            if (assignedList.innerHTML === '') assignedList.innerHTML = '<p class="text-muted text-center mt-3">No users have been assigned tasks yet.</p>';
            if (unassignedList.innerHTML === '') unassignedList.innerHTML = '<p class="text-muted text-center mt-3">All employees have been assigned tasks.</p>';
        }

        async function loadAllTaskHistory() {
            const [usersSnapshot, assignedTasksSnapshot, pendingTasksSnapshot] = await Promise.all([
                get(usersRef),
                get(assignedTasksRef),
                get(tasksForApprovalRef)
            ]);

            const usersData = usersSnapshot.val() || {};
            const assignedTasksData = assignedTasksSnapshot.val() || {};
            const pendingTasksData = pendingTasksSnapshot.val() || {};

            historyFilterUser.innerHTML = '<option value="">All Users</option>';
            Object.entries(usersData).forEach(([uid, user]) => {
                const option = document.createElement('option');
                option.value = uid;
                option.textContent = user.name;
                historyFilterUser.appendChild(option);
            });
            
            function renderHistory() {
                let outputHtml = '';
                const allTasks = [];

                Object.entries(assignedTasksData).forEach(([taskId, task]) => {
                    allTasks.push({ taskId, ...task, type: 'assigned' });
                });

                Object.entries(pendingTasksData).forEach(([taskId, task]) => {
                    allTasks.push({ taskId, ...task, type: 'pending-approval' });
                });

                const filteredTasks = allTasks.filter(task => {
                    const selectedUser = historyFilterUser.value;
                    const selectedDate = historyFilterDate.value;
                    let matchesUser = true;
                    let matchesDate = true;

                    if (selectedUser) {
                        matchesUser = task.userId === selectedUser;
                    }
                    if (selectedDate) {
                        matchesDate = task.date === selectedDate;
                    }

                    return matchesUser && matchesDate;
                });

                if (filteredTasks.length === 0) {
                    adminHistoryList.innerHTML = '<p class="text-center">No tasks found for the selected filters.</p>';
                    return;
                }

                const tasksByUserAndDate = {};
                for (const task of filteredTasks) {
                    const userKey = `${task.userId}_${task.date}`;
                    if (!tasksByUserAndDate[userKey]) {
                        tasksByUserAndDate[userKey] = {
                            userName: usersData[task.userId]?.name || 'Unknown User',
                            date: task.date,
                            tasks: []
                        };
                    }
                    tasksByUserAndDate[userKey].tasks.push(task);
                }

                const sortedUserDates = Object.keys(tasksByUserAndDate).sort((a, b) => {
                    const dateA = tasksByUserAndDate[a].date;
                    const dateB = tasksByUserAndDate[b].date;
                    return dateB.localeCompare(dateA);
                });
                
                for (const userDateKey of sortedUserDates) {
                    const group = tasksByUserAndDate[userDateKey];
                    outputHtml += `<div class="col-12 mb-4"><div class="card"><div class="card-header bg-secondary text-white"><h4 class="mb-0">${group.userName} - ${group.date}</h4></div><ul class="list-group list-group-flush">`;
                    
                    group.tasks.forEach(task => {
                        if (task.type === 'assigned') {
                            const assignedBy = usersData[task.managerId]?.name || 'Unknown Manager';
                            outputHtml += `
                                <li class="list-group-item">
                                    <strong>Assigned By:</strong> ${assignedBy} <br>
                                    <strong>Targets:</strong>
                                    <ul>
                            `;
                            Object.values(task.targets).forEach(target => {
                                outputHtml += `
                                        <li>
                                            <span class="badge bg-${getPriorityColor(target.priority)} me-2">${target.priority}</span>
                                            ${target.description} 
                                            <span class="badge bg-${target.completed ? 'success' : 'warning'} ms-2">${target.completed ? 'Completed' : 'Pending'}</span>
                                        </li>
                                `;
                            });
                            outputHtml += '</ul></li>';
                        } else if (task.type === 'pending-approval') {
                            const submittedBy = task.submittedBy?.name || 'Unknown Employee';
                            outputHtml += `
                                <li class="list-group-item">
                                    <strong>Task:</strong> ${task.task} <br>
                                    <strong>Status:</strong> <span class="badge bg-info">${task.status}</span><br>
                                    <small class="text-muted">Submitted by: ${submittedBy}</small>
                                </li>
                            `;
                        }
                    });
                    outputHtml += '</ul></div></div>';
                }
                adminHistoryList.innerHTML = outputHtml;
            }

            historyFilterUser.addEventListener('change', renderHistory);
            historyFilterDate.addEventListener('change', renderHistory);
            renderHistory();
        }

        // Admin Panel
        async function loadAllUsersForAdmin() {
            userSelect.innerHTML = '<option value="" disabled selected>Select a User</option>';
            employeeOfMonthSelect.innerHTML = '<option value="" disabled selected>No "Excellent" employees found</option>';

            const snapshot = await get(usersRef);
            const usersData = snapshot.val();
            const excellentEmployees = [];
            
            for (const [uid, user] of Object.entries(usersData || {})) {
                const option = document.createElement('option');
                option.value = uid;
                option.textContent = user.name;
                userSelect.appendChild(option);

                const efficiency = await getEfficiency(uid);
                if (efficiency.rating === 'Excellent') {
                    const certOption = document.createElement('option');
                    certOption.value = uid;
                    certOption.textContent = user.name;
                    employeeOfMonthSelect.appendChild(certOption);
                    excellentEmployees.push(user);
                }
            }

            if (excellentEmployees.length > 0) {
                employeeOfMonthSelect.disabled = false;
            } else {
                employeeOfMonthSelect.disabled = true;
            }
            userDetailsPanel.classList.add('d-none');
        }

        async function getEfficiency(userId) {
            const tasksSnapshot = await get(assignedTasksRef);
            const tasksData = tasksSnapshot.val();

            let totalTasks = 0;
            let completedTasks = 0;
            if (tasksData) {
                Object.values(tasksData).forEach(task => {
                    if (task.userId === userId && task.targets) {
                        Object.values(task.targets).forEach(target => {
                            totalTasks++;
                            if (target.completed) {
                                completedTasks++;
                            }
                        });
                    }
                });
            }
            
            const completionRate = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
            let rating = 'N/A';
            if (completionRate >= 95) rating = 'Excellent';
            else if (completionRate >= 90) rating = 'Very Good';
            else if (completionRate >= 75) rating = 'Good';
            else if (completionRate >= 50) rating = 'Moderate';
            else if (completionRate >= 25) rating = 'Low';
            else rating = 'Very Low';
            
            return {
                totalTasks,
                completedTasks,
                rate: completionRate.toFixed(1),
                rating
            };
        }

        userSelect.addEventListener('change', async () => {
            const selectedUserId = userSelect.value;
            if (!selectedUserId) {
                userDetailsPanel.classList.add('d-none');
                return;
            }

            userDetailsPanel.classList.remove('d-none');
            const userData = allUsersData[selectedUserId];
            roleSelect.value = userData.role;

            const efficiency = await getEfficiency(selectedUserId);
            
            tasksGivenCount.textContent = efficiency.totalTasks;
            tasksCompletedCount.textContent = efficiency.completedTasks;
            efficiencyRate.textContent = `${efficiency.rate}%`;
            efficiencyRating.textContent = efficiency.rating;

            const pendingRate = 100 - parseFloat(efficiency.rate);
            if (completionChart) completionChart.destroy();
            completionChart = new Chart(completionChartCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Pending'],
                    datasets: [{
                        data: [parseFloat(efficiency.rate), pendingRate],
                        backgroundColor: ['#198754', '#ffc107'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '70%',
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    return `${label}: ${value.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });
        });

        assignRoleBtn.addEventListener('click', async () => {
            const userId = userSelect.value;
            const newRole = roleSelect.value;
            const userRef = ref(db, `users/${userId}`);

            if (auth.currentUser.uid === userId) {
                showAlert(document.getElementById('role-alert-container'), 'Cannot change your own role.', 'danger');
                return;
            }
            
            try {
                await update(userRef, { role: newRole });
                showAlert(document.getElementById('role-alert-container'), `Role assigned to ${newRole} successfully!`, 'success');
                allUsersData[userId].role = newRole; // Update local cache
            } catch (error) {
                showAlert(document.getElementById('role-alert-container'), `Failed to assign role: ${error.message}`, 'danger');
            }
        });

        // Certificate Generation
        generateCertificateBtn.addEventListener('click', async () => {
            const selectedUserId = employeeOfMonthSelect.value;
            if (!selectedUserId) {
                showAlert(document.getElementById('certificate-alert-container'), 'Please select an employee to generate the certificate.', 'warning');
                certificatePreviewContainer.classList.add('d-none');
                return;
            }

            const userData = allUsersData[selectedUserId];

            if (userData) {
                currentCertData = {
                    employeeId: selectedUserId,
                    employeeName: userData.name,
                    employeeEmail: userData.email,
                    date: getCurrentDate()
                };

                certEmployeeName.textContent = `Mr./Ms. ${userData.name}`;
                certMonth.textContent = getMonthName(getCurrentDate());
                certDate.textContent = getCurrentDate();
                
                certificatePreviewContainer.classList.remove('d-none');
                
                const newCertRef = push(ref(db, `certificates/${selectedUserId}`));
                await set(newCertRef, currentCertData);
                showAlert(document.getElementById('certificate-alert-container'), 'Certificate generated and saved!', 'success');
            } else {
                showAlert(document.getElementById('certificate-alert-container'), 'Could not retrieve employee data.', 'danger');
                certificatePreviewContainer.classList.add('d-none');
            }
        });

        downloadCertBtn.addEventListener('click', () => {
            if (currentCertData) {
                downloadCertificate(currentCertData);
            }
        });
        
        sendCertBtn.addEventListener('click', () => {
            if (currentCertData && currentCertData.employeeEmail) {
                const subject = encodeURIComponent('Congratulations on Your Appreciation Certificate!');
                const body = encodeURIComponent(`Dear ${currentCertData.employeeName},\n\nCongratulations on being recognized as the Employee of the Month for ${getMonthName(currentCertData.date)}!\n\nThis certificate is a token of our appreciation for your hard work and dedication.\n\nBest regards,\nMaheshwari Computers Pvt. Ltd.`);
                window.location.href = `mailto:${currentCertData.employeeEmail}?subject=${subject}&body=${body}`;
            } else {
                showAlert(document.getElementById('certificate-alert-container'), 'Employee email not available.', 'danger');
            }
        });

        function downloadCertificate(certData) {
            const element = certificateContent;
            const opt = {
                margin: 1,
                filename: `Certificate_${certData.employeeName}_${certData.date}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
            };
            html2pdf().set(opt).from(element).save();
        }

        // Profile Page
        async function loadProfile() {
            const user = auth.currentUser;
            const userRef = ref(db, `users/${user.uid}`);
            const snapshot = await get(userRef);
            const userData = snapshot.val();
            
            profileNameInput.value = userData.name || '';
            profileEmployeeIdInput.value = userData.employeeId || '';
            profileMobileInput.value = userData.mobile || '';
            profileEmailInput.value = userData.email || '';
            profileLocationInput.value = userData.location || '';
            profileProjectInput.value = userData.project || '';
            profileRoleInput.value = userData.role || 'employee';
        }

        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            const userRef = ref(db, `users/${user.uid}`);
            const updatedName = profileNameInput.value;
            const updatedMobile = profileMobileInput.value;
            const updatedLocation = profileLocationInput.value;
            const updatedProject = profileProjectInput.value;

            try {
                await update(userRef, {
                    name: updatedName,
                    mobile: updatedMobile,
                    location: updatedLocation,
                    project: updatedProject
                });
                await updateProfile(user, { displayName: updatedName });
                userDisplayName.textContent = updatedName;
                showAlert(document.getElementById('profile-alert-container'), 'Profile updated successfully!', 'success');
            } catch (error) {
                showAlert(document.getElementById('profile-alert-container'), `Failed to update profile: ${error.message}`, 'danger');
            }
        });

        // Initialize first task input for employee add task page
        document.addEventListener('DOMContentLoaded', () => {
            updateRemoveButtons(employeeTargetsContainer);
        });

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
